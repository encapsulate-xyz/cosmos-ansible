---
- name: Set project and service identifier in facts
  ansible.builtin.set_fact:
    project: "{{ group_names[0] }}"
    service_identifier: "{{ group_names[0] }}{{ '' if type in default_node_types else '-' + type }}"

- name: Set architecture variable based on system architecture
  ansible.builtin.set_fact:
    system_architecture: "{{ architecture_map[ansible_architecture] | default(ansible_architecture) }}"

- name: Display environment being deployed to
  ansible.builtin.debug:
    msg:
      - "Deploying to Host: {{ inventory_hostname }}"
      - "Groups: {{ group_names }}"
      - "Project: {{ project }}"
      - "Environment: {{ env }}"
      - "Type: {{ type }}"
      - "Version: {{ vars[project][type].version }}"
      - "Username: {{ service_identifier }}"
      - "Service Name: {{ service_identifier }}"
      - "Operating System: {{ ansible_system | lower }}"
      - "System Architecture: {{ system_architecture }}"

- name: Set all port variables dynamically
  ansible.builtin.set_fact:
    p2p_port: "{{ vars[project][type].ports.prefix ~ (vars[project][type].ports.suffix.p2p | default(ports.suffix.p2p)) }}"
    rpc_port: "{{ vars[project][type].ports.prefix ~ (vars[project][type].ports.suffix.rpc | default(ports.suffix.rpc)) }}"
    abci_port: "{{ vars[project][type].ports.prefix ~ (vars[project][type].ports.suffix.abci | default(ports.suffix.abci)) }}"
    prometheus_port: "{{ vars[project][type].ports.prefix ~ (vars[project][type].ports.suffix.prometheus | default(ports.suffix.prometheus)) }}"
    pprof_port: "{{ vars[project][type].ports.prefix ~ (vars[project][type].ports.suffix.pprof | default(ports.suffix.pprof)) }}"
    rest_api_port: "{{ vars[project][type].ports.prefix ~ (vars[project][type].ports.suffix.rest_api | default(ports.suffix.rest_api)) }}"
    rosetta_port: "{{ vars[project][type].ports.prefix ~ (vars[project][type].ports.suffix.rosetta | default(ports.suffix.rosetta)) }}"
    grpc_port: "{{ vars[project][type].ports.prefix ~ (vars[project][type].ports.suffix.grpc | default(ports.suffix.grpc)) }}"
    grpc_web_port: "{{ vars[project][type].ports.prefix ~ (vars[project][type].ports.suffix.grpc_web | default(ports.suffix.grpc_web)) }}"
  when: type == "validator" or type == "fullnode"

- name: Set all port variables dynamically for price feeder
  ansible.builtin.set_fact:
    price_feeder_port: "{{ vars[project].validator.ports.prefix ~ (vars[project][type].ports.suffix.price_feeder | default(ports.suffix.price_feeder)) }}"
    grpc_port: "{{ vars[project].validator.ports.prefix ~ (vars[project].validator.ports.suffix.grpc | default(ports.suffix.grpc)) }}"
    rpc_port: "{{ vars[project].validator.ports.prefix ~ (vars[project].validator.ports.suffix.rpc | default(ports.suffix.rpc)) }}"
  when: type == "pf"

- name: Set port variable for axelar vald service
  ansible.builtin.set_fact:
    tofnd_port: "{{ vars[project].validator.ports.prefix ~ (vars[project].validator.ports.suffix.tofnd | default(ports.suffix.tofnd)) }}"
  when: type in ["vald", "tofnd"]

- name: Set all port variables dynamically for Execution Client
  ansible.builtin.set_fact:
    execution_rpc_port: "{{ vars[project].validator.ports.prefix ~ (vars[project][type].ports.suffix.execution_rpc | default(ports.suffix.execution_rpc)) }}"
    execution_websocket_port: "{{ vars[project].validator.ports.prefix ~ (vars[project].validator.ports.suffix.execution_websocket | default(ports.suffix.execution_websocket)) }}"
    execution_metrics_port: "{{ vars[project].validator.ports.prefix ~ (vars[project].validator.ports.suffix.execution_metrics | default(ports.suffix.execution_metrics)) }}"
  when: execution_client | default(false) | bool

- name: Display all port variables
  ansible.builtin.debug:
    msg:
      - "P2P Port: {{ p2p_port }}"
      - "RPC Port: {{ rpc_port }}"
      - "ABCI Port: {{ abci_port }}"
      - "Prometheus Port: {{ prometheus_port }}"
      - "Pprof Port: {{ pprof_port }}"
      - "REST API Port: {{ rest_api_port }}"
      - "Rosetta Port: {{ rosetta_port }}"
      - "gRPC Port: {{ grpc_port }}"
      - "gRPC-Web Port: {{ grpc_web_port }}"
  when: type == "validator" or type == "fullnode"

- name: Display all price feeder port variables
  ansible.builtin.debug:
    msg:
      - "RPC Port: {{ rpc_port }}"
      - "gRPC Port: {{ grpc_port }}"
      - "Price-Feeder Port: {{ price_feeder_port }}"
  when: type == "pf"

- name: Display port variable of axelar vald service
  ansible.builtin.debug:
    msg: "Tofnd Port: {{ tofnd_port }}"
  when: type in ["vald", "tofnd"]

- name: Display all Execution Client port variables
  ansible.builtin.debug:
    msg:
      - "Execution RPC Port: {{ execution_rpc_port }}"
      - "Execution Web Socket Port: {{ execution_websocket_port }}"
      - "Execution Metrics Port: {{ execution_metrics_port }}"
  when: execution_client | default(false) | bool

- name: Coordinated Update
  ansible.builtin.debug:
    msg:
      - "Coordinated Update at Height: {{ upgrade_height }}"
  when: upgrade_height is defined

- name: Confirm deployment details
  ansible.builtin.pause:
    seconds: 40

- name: Please confirm again
  ansible.builtin.debug:
    msg:
      - "Deploying to Host: {{ inventory_hostname }}"
      - "Project: {{ project }}"
      - "Environment: {{ env }}"
      - "Type: {{ type }}"

- name: Confirm deployment details
  ansible.builtin.pause:
    seconds: 20

- name: Include configure ufw task
  ansible.builtin.include_tasks: tasks/configure_ufw.yml
